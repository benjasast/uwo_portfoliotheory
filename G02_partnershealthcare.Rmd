---
title: "Partners Healthcare"
subtitle: Econ 9523
author: Benjamin Sas Trakinsky
output: rmarkdown::github_document
---

Libraries
```{r, error=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
```

Input Data
```{r, error=FALSE, warning=FALSE}
df <- tibble(
assets = c("US Equity", "Foreign Equity", "Bonds", "REITs","Commodities"),
e_return = c(12.94, 12.42,5.40,9.44,10.55),
sd = c(15.21,14.44,11.10,13.54,18.43)
)

# Correlation matrix
corr_matrix <- cbind(
  c(1.00,	0.62,	0.25,	0.56,	-0.02),
  c(0.62,	1.00,	0.06,	0.40,	0.01),
  c(0.25,	0.06,	1.00,	0.16,	-0.07),
  c(0.56,	0.40,	0.16,	1.00,	-0.01),
  c(-0.02,	0.01,	-0.07,	-0.01,	1.00)
)
```

Before we can add portfolios, we need to obtain the variance-covariance matrix. Only with it we can calculate the SD of portfolios.
```{r, error=FALSE, warning=FALSE}
# Obtain var-cov matrix
stdevs <- df$sd
b <- stdevs %*% t(stdevs)  
varcov <- b * corr_matrix
```

The variance-covariance matrix is:
```{r, error=FALSE, warning=FALSE}
varcov
```


## Generate STP and LTP Portfolios
```{r, error=FALSE, warning=FALSE}
ltp <- c(.55,.30,.15,0,0)

e_ltp <- ltp%*%df$e_return
sd_ltp <- sqrt(t(ltp) %*% varcov %*% ltp)

ltp <- c("LTP",e_ltp,sd_ltp)
stp <- c("STP",3.20,0)

# Main dataframe with assets and STP and LTP
df <- rbind(df,ltp,stp)
df <- df %>%
  mutate(e_return = as.numeric(e_return),
         sd = as.numeric(sd))
```

Let's check a graph with the expected returns and SD of each asset, and the LTP and STP portfolios.
```{r, error=FALSE, warning=FALSE}
df %>% 
  ggplot(aes(sd,e_return)) +
  geom_point() +
  geom_text(aes(label=assets), vjust=-1) +
  xlim(0,20) +
  ylim(0,20)
```

There seems to be a linear relationship between risk and returns, where the greater returns are obtained with additional risk (in terms of SD). Commodities seem a bit off this trend.


## Combination of STP and LTP portfolios

We will create portfolios varying the allocations assigned to the STP and LTP portfolios.

```{r, error=FALSE, warning=FALSE}
w1 <- seq(0,1,.2)
w2 <- 1-w1
w <- rbind(w1,w2)

df2 <- df %>% filter(assets=="LTP" | assets=="STP")

stp_ltp_return <- t(w) %*% df2$e_return


# Create a dataframe for the portfolios
df2 <- df2 %>%  select(assets) %>% 
  cbind(t(w),stp_ltp_return)

# Get SD, is only based in the SD of LTP as STP has sd=0
df2 <- df2 %>% 
  mutate(sd = sqrt(12.02^2*w1^2))
```

Graph of portfolios with zero correlation:
```{r, error=FALSE, warning=FALSE}
df2 %>% 
  ggplot(aes(sd,stp_ltp_return)) +
  geom_point() +
  xlim(0,15) +
  ylim(0,15)
```

The portfolios are on a straight line as there is no correlation between the STP and LTP portfolios. As the allocation to LTP growsm, the SD grows linearly as there is no interacting covariance term.

## Portfolios of US equities and bonds
We will check how the expected return and SD of portfolios of US equities and bonds change, as we move the allocations between assets, and the correlation between the assets.

```{r, error=FALSE, warning=FALSE}
w1 <- seq(0,1,.025)
w2 <- 1-w1
w <- rbind(w1,w2)

df3 <- df %>% filter(assets=="US Equity" | assets=="Bonds")

# Obtain varcov matrix - initial run with correlation -1
corr_matrix2 <- cbind(c(1,-1),c(-1,1))
b <- df3$sd %*% t(df3$sd)  
varcov3 <- b * corr_matrix2 

# Obtain portfolios returns and sd
p1_return <- t(w) %*% df3$e_return
p1_sd <- t(diag(sqrt(t(w) %*% varcov3 %*% w)))
Corr <- (rep(-1,length(p1_sd)))

df4 <- cbind(t(w),p1_return,t(p1_sd),Corr)
```

Now we will use the same code above to loop through different correlation values.
```{r, error=FALSE, warning=FALSE}
# Corr
s <- c(-.75,-.5,0,.25,.5,.75,1)

for (k in s) {
  corr_matrix2 <- cbind(c(1,k),c(k,1))
  b <- df3$sd %*% t(df3$sd)  
  varcov3 <- b * corr_matrix2
  
  # Obtain portfolios returns and sd
  p1_return <- t(w) %*% df3$e_return
  p1_sd <- t(diag(sqrt(t(w) %*% varcov3 %*% w)))
  Corr <- (rep(k,length(p1_sd)))  
  
  df_aux <- cbind(t(w),p1_return,t(p1_sd),Corr)
  
  df4 <- rbind(df4,df_aux)
  
}

# modify DF4
df4 <- as_tibble(df4) %>% 
  mutate(e_return = V3,
         sd = V4) %>% 
  select(w1,w2,Corr,e_return,sd)
```

The resulting figure shows us how the portfolio line moves at different correlation values.

```{r, error=FALSE, warning=FALSE}
# Graph returns
df4 %>% 
  ggplot(aes(sd,e_return)) +
  geom_point(aes(color=Corr)) +
  geom_path(aes(color=Corr)) +
  xlim(0,15) +
  ylim(5,15) +
  ylab("Expected Return") +
  xlab("SD") +
  ggtitle("Portfolios of US Equities and Bonds")
```

We can observe the two extreme cases. When the correlation between assets is -1 risk can be completely hedged. When the correlation between assets is 1 the portfolios moves as a straight line. Any intermmediate case will be curve-shaped as the covariance terms gain more influence as we increase the asset mix.
 
## 3-Asset Portfolio - Fixed Bonds

Now we will explore the efficient frontier for 3-assets, US equity, Foreign equity, and US bonds. To simplify the analysis at first the allocation of bonds will be fixed at 20%. What will vary is the allocations toward foreign and US equity.

```{r, error=FALSE, warning=FALSE}
w3 <- rep(0.2,6)
w1 <- c(0.30,0.40,0.50,0.60,0.70,0.80)
w2 <- 1-w3-w1
w <- cbind(w1,w2,w3)

# New Data frame
df5 <- df %>% filter(assets=="US Equity" | assets=="Foreign Equity" | assets=="Bonds")

# Variance covariance matrix of assets
varcov4 <- varcov[1:3,1:3]

# Obtain expected returns and sd of each portfolio
p2_return <- w %*% df5$e_return
p2_sd <- sqrt(diag(w %*% varcov4 %*% t(w))) 

df6 <- cbind(w,p2_return,p2_sd)
df6 <- as_tibble(df6)


df6 <- df6 %>% mutate(e_return=V4, sd = p2_sd, portfolio = rep("3-Asset, Fixed Bonds"))
df6 <- df6 %>% select(w1,w2,w3,e_return,sd,portfolio)


# Add the STP and LTP portfolios, and assets
df6 <- df6 %>% full_join(df)

df6 <- df6 %>% mutate(portfolio2 = portfolio %>% 
                 is.na() %>% 
                 ifelse(assets,portfolio)) 

# add the two-asset portfolio with 0.25 correlation (the original)
df_aux <- df4 %>% filter(Corr==0.25) %>% 
  select(w1,w2,e_return,sd) %>% 
  mutate(portfolio2="2-Asset")

df6 <- df6 %>% full_join(df_aux)
```

If we graph the new portfolio with three assets we obtain:
```{r, error=FALSE, warning=FALSE}
# Graph
df6 %>% 
  ggplot(aes(sd,e_return)) +
  geom_point(aes(color=portfolio2)) +
  geom_path(aes(color=portfolio2)) +
  xlim(0,15) +
  ylim(0,15) +
  ylab("Expected Return") +
  xlab("SD") +
  ggtitle("Portfolio of Bonds, US and Foreign Equity", subtitle = "Bonds fixed at 20% allocation") 
```

Now the 3-asset mix is clearly better than a similar 2-asset portfolio of US bonds and equities. For the same level of expected returns we can obtain a portfolio with less risk (SD). The 3-asset portfolio has a point in common with the 2-asset one, it is when the allocation to foreign equity is zero.

## Varying 3-asset portfolio

Input weights, get returns and SD
```{r, error=FALSE, warning=FALSE}
# US Equity, Foreign Equity and Bonds
w <- cbind(
c(0.000,	0.228,	0.772),
c(0.000,	0.299,	0.701),
c(0.038,	0.330,	0.632),
c(0.087,	0.348,	0.565),
c(0.136,	0.367,	0.497),
c(0.185,	0.386,	0.429),
c(0.234,	0.404,	0.362),
c(0.283,	0.423,	0.294),
c(0.381,	0.460,	0.159),
c(0.332,	0.442,	0.227),
c(0.430,	0.479,	0.092),
c(0.479,	0.497,	0.024)
)

w <- t(w)

# Obtain returns and sd
p3_return <- w %*% df5$e_return 
p3_sd <- sqrt(diag(w %*% varcov4 %*% t(w))) 

# Create auxiliar df
df_aux <- tibble(w,e_return=p3_return,sd=p3_sd)
df_aux <- df_aux %>% mutate(portfolio2="3-Assets",w1=w[,1],w2=w[,2],w3=w[,3]) %>% 
  select(w1,w2,w3,e_return,sd,portfolio2)

# Join with df6
df6 <- df6 %>% full_join(df_aux)

```

The graph with three assets:
```{r, error=FALSE, warning=FALSE}
# Graph returns
df6 %>% 
  ggplot(aes(sd,e_return)) +
  geom_point(aes(color=portfolio2)) +
  geom_path(aes(color=portfolio2)) +
  xlim(0,15) +
  ylim(0,15) +
  ylab("Expected Return") +
  xlab("SD") +
  ggtitle("Portfolio of Bonds, US and Foreign Equity", subtitle = "Varying allocations for the 3-Assets") 
```

This reflects the importance of optimizing the weights. The portfolio with fixed 20% on bonds is clearly inferior to the 3-Asset optimal portfolio.

## 4 Assets Portfolios

We will first add REITs to the 3-asset portfolio.

```{r, error=FALSE, warning=FALSE}
w <- cbind(
c(0.000,	0.102,	0.678,	0.220),
c(0.000,	0.170,	0.605,	0.225),
c(0.000,	0.239,	0.532,	0.229),
c(0.004,	0.303,	0.460,	0.232),
c(0.059,	0.325,	0.400,	0.216),
c(0.114,	0.347,	0.340,	0.199),
c(0.169,	0.369,	0.280,	0.183),
c(0.224,	0.391,	0.219,	0.166),
c(0.278,	0.412,	0.159,	0.150),
c(0.333,	0.434,	0.099,	0.133),
c(0.388,	0.456,	0.039,	0.117),
c(0.465,	0.481,	0.000,	0.054))

w <- t(w)

# Get for returns and sd
df_aux1 <- df %>% filter(assets=="US Equity" | assets=="Foreign Equity" | assets=="Bonds" | assets=="REITs") %>% 
  select(assets,e_return,sd)

# Get varcov matrix
varcov5 <- varcov[1:4,1:4]


# Obtain returns and sd
p4_return <- w %*% df_aux1$e_return 
p4_sd <- sqrt(diag(w %*% varcov5 %*% t(w))) 


# Aux DF
df_aux2 <- tibble(w,p4_return,p4_sd) %>% 
  transmute(w1=w[,1],w2=w[,2],w3=w[,3],e_return=p4_return,sd=p4_sd) %>% 
  mutate(portfolio2="3-Asset + REITs")

# Join with df6, to look at all distributions
df6 <- df6 %>% full_join(df_aux2)
```

Now let's add Commodities instead of REITs

```{r, error=FALSE, warning=FALSE}

w <- cbind(
c(0.000,	0.113,	0.713,	0.175),
c(0.000,	0.176,	0.683,	0.187),
c(0.001,	0.238,	0.562,	0.198),
c(0.048,	0.253,	0.492,	0.207),
c(0.096,	0.268,	0.421,	0.215),
c(0.143,	0.283,	0.351,	0.224),
c(0.190,	0.297,	0.280,	0.232),
c(0.238,	0.312,	0.210,	0.240),
c(0.285,	0.327,	0.139,	0.249),
c(0.333,	0.342,	0.069,	0.257),
c(0.383,	0.356,	0.000,	0.261),
c(0.557,	0.355,	0.000,	0.088)
)

w <- t(w)

# Get for returns and sd
df_aux1 <- df %>% filter(assets=="US Equity" | assets=="Foreign Equity" | assets=="Bonds" | assets=="Commodities") %>% 
  select(assets,e_return,sd)

# Get varcov matrix
varcov5 <- varcov[c(1,2,3,5),c(1,2,3,5)]


# Obtain returns and sd
p5_return <- w %*% df_aux1$e_return 
p5_sd <- sqrt(diag(w %*% varcov5 %*% t(w))) 


# Aux DF
df_aux2 <- tibble(w,p5_return,p5_sd) %>% 
  transmute(w1=w[,1],w2=w[,2],w3=w[,3],e_return=p5_return,sd=p5_sd) %>% 
  mutate(portfolio2="3-Asset + Commodities")


# Join with df6, to look at all distributions
df6 <- df6 %>% full_join(df_aux2)
```

Graph with both 4-Asset portfolios

```{r, error=FALSE, warning=FALSE}
# Graph returns
df6 %>% 
  ggplot(aes(sd,e_return)) +
  geom_point(aes(color=portfolio2)) +
  geom_path(aes(color=portfolio2)) +
  xlim(0,15) +
  ylim(0,15) +
  ylab("Expected Return") +
  xlab("SD") +
  ggtitle("Portfolio of Bonds, US and Foreign Equity + REITs and + Commodities") 
```

Adding REITs does not make a big difference, no noticeable better risk-adjusted returns are obtained. On the other hand adding commodities was very effective pushing the efficient frontier. Why? Commodities are negatively correlated with some of the other assets, or minimimally correlated with others, making its addition very good to hedge risk.

## 5-Assets

Now we will include all assets:

```{r, error=FALSE, warning=FALSE}
w <- cbind(
c(0.000,	0.020,	0.643,	0.180,	0.158),
c(0.000,	0.082,	0.567,	0.182,	0.170),
c(0.000,	0.144,	0.491,	0.183,	0.181),
c(0.000,	0.207,	0.415,	0.185,	0.193),
c(0.036,	0.239,	0.348,	0.174,	0.203),
c(0.089,	0.257,	0.285,	0.156,	0.213),
c(0.143,	0.275,	0.222,	0.138,	0.223),
c(0.197,	0.292,	0.159,	0.119,	0.232),
c(0.250,	0.310,	0.097,	0.101,	0.242),
c(0.304,	0.328,	0.034,	0.083,	0.251),
c(0.387,	0.354,	0.000,	0.010,	0.250)
)

w <- t(w)



# Get for returns and sd
df_aux1 <- df %>% filter(assets=="US Equity" | assets=="Foreign Equity" | assets=="Bonds" | assets=="REITs" |assets=="Commodities") %>% 
  select(assets,e_return,sd)

# Obtain returns and sd
p6_return <- w %*% df_aux1$e_return 
p6_sd <- sqrt(diag(w %*% varcov %*% t(w))) 

# Aux DF
df_aux2 <- tibble(w,p6_return,p6_sd) %>% 
  transmute(w1=w[,1],w2=w[,2],w3=w[,3],e_return=p6_return,sd=p6_sd) %>% 
  mutate(portfolio2="5 Assets")


# Join with df6, to look at all distributions
df6 <- df6 %>% full_join(df_aux2)

```

The figure including all returns:

```{r, error=FALSE, warning=FALSE}

# Graph returns
df6 %>% 
  ggplot(aes(sd,e_return)) +
  geom_point(aes(color=portfolio2)) +
  geom_path(aes(color=portfolio2)) +
  xlim(0,15) +
  ylim(0,15) +
  ylab("Expected Return") +
  xlab("SD") +
  geom_text(aes(label=assets), vjust=1.5) +
  ggtitle("Portfolio of Bonds, US and Foreign Equity, REITs, and Commodities")
```

Clearly the best portfolio is attained by including all assets. We obtain the best mix of assets in order to minmize variance at specified returns



















